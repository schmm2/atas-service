!function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}var t={};n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=2)}([function(e,n){e.exports=require("mongoose")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.appConstants={NAME:"ATAS Service",MQTT_BROKER_URL:"wss://m21.cloudmqtt.com",MQTT_BROKER_PORT:"37505",MQTT_BROKER_USER:"rpyifhax",MQTT_BROKER_PASSWORD:"SNr0uCxBVOK4",MQTT_TOPIC_TRACKER:"atas/devices/",MONGODB_URL:"mongodb://127.0.0.1/atasdb"}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.app=void 0;var o=t(1);console.log("start atas-service");var r=t(3),s=t(4),a=process.env.PORT||8e3,i=n.app=r(),c=t(0),u=(t(8),t(9)),p=t(10);c.Promise=global.Promise;c.connect(o.appConstants.MONGODB_URL,{useMongoClient:!0});i.use(p()),i.use(u.urlencoded({extended:!0})),i.use(u.json()),i.listen(a,function(){console.log("Server listening on port",a)}),t(11)(i);new s(c);c.connection.on("connected",function(){console.log("Mongoose default connection open to "+o.appConstants.MONGODB_URL)}),c.connection.on("error",function(e){console.log("Mongoose default connection error: "+e)}),c.connection.on("disconnected",function(){console.log("Mongoose default connection disconnected")}),process.on("SIGINT",function(){c.connection.close(function(){console.log("Mongoose default connection disconnected through app termination"),process.exit(0)})})},function(e,n){e.exports=require("express")},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),s=t(1),a=t(5),i=function(e){return e&&e.__esModule?e:{default:e}}(a),c=t(6),u=t(7);e.exports=function(){function e(n){o(this,e),this.mongoose=n,this.mqttTrackerObserver=null,this.trackersInsideDangerzoneList=[],this.message_alarmOff='{"port":1,"payload_fields":{"alarm": false}}',this.message_alarmOn='{"port":1,"payload_fields":{"alarm": true}}',this.mqttOptions={port:s.appConstants.MQTT_BROKER_PORT,host:s.appConstants.MQTT_BROKER_URL,clientId:s.appConstants.NAME+Math.random().toString(16).substr(2,8),username:s.appConstants.MQTT_BROKER_USER,password:s.appConstants.MQTT_BROKER_PASSWORD,keepalive:60,reconnectPeriod:2e3,protocolId:"MQIsdp",protocolVersion:3,clean:!0,encoding:"utf8"},this.trackerIDPattern=s.appConstants.MQTT_TOPIC_TRACKER+"+id/#path",this.init()}return r(e,[{key:"init",value:function(){function e(e){console.log("ERROR"+e)}this.mqttTrackerObserver=c.connect(s.appConstants.MQTT_BROKER_URL,this.mqttOptions);var n=this;this.mqttTrackerObserver.on("connect",function(){console.log(s.appConstants.NAME+" - Mqtt connected"),n.mqttTrackerObserver.subscribe(s.appConstants.MQTT_TOPIC_TRACKER+"+/up/gps"),n.mqttTrackerObserver.subscribe(s.appConstants.MQTT_TOPIC_TRACKER+"+/up/buttonpressed")}),this.mqttTrackerObserver.on("message",function(t,o,r){var a=(0,i.default)(n.trackerIDPattern).exec,c=a(t).id,p=s.appConstants.MQTT_TOPIC_TRACKER+c+"/down";switch(t){case s.appConstants.MQTT_TOPIC_TRACKER+c+"/up/gps":var l=JSON.parse(o.toString()),d=n.trackersInsideDangerzoneList.indexOf(c);n.mongoose.model("Dangerzone").find().exec(function(t,o){var r=!1;if(t)return e(t);for(var s=0;s<o.length;s++)if(u(l,o[s])){-1==d&&(n.mqttTrackerObserver.publish(p,n.message_alarmOn),n.trackersInsideDangerzoneList.push(c)),r=!0;break}0==r&&d>-1&&(n.mqttTrackerObserver.publish(p,n.message_alarmOff),n.trackersInsideDangerzoneList.splice(d,1))})}})}}]),e}()},function(e,n){e.exports=require("mqtt-regex")},function(e,n){e.exports=require("mqtt")},function(e,n,t){"use strict";e.exports=function(e,n){for(var t=e.lng,o=e.lat,r=n.points,s=!1,a=0,i=r.length-1;a<r.length;i=a++){var c=r[a].lng,u=r[a].lat,p=r[i].lng,l=r[i].lat;u>o!=l>o&&t<(p-c)*(o-u)/(l-u)+c&&(s=!s)}return s}},function(e,n,t){"use strict";var o=t(0),r=o.Schema,s=new r({createDate:{type:Date,default:Date.now},points:[{lat:Number,lng:Number}]});e.exports=o.model("Dangerzone",s)},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cors")},function(e,n,t){"use strict";e.exports=function(e){var n=t(12);e.route("/dangerzones").get(n.listDangerzones).post(n.createDangerzone),e.route("/dangerzones/:dangerzoneId").get(n.getDangerzone).put(n.updateDangerzone).delete(n.deleteDangerzone),e.use(function(e,n){n.status(404).send({url:e.originalUrl+" not found"})})}},function(e,n,t){"use strict";var o=t(0),r=o.model("Dangerzone");n.listDangerzones=function(e,n){r.find({},function(e,t){e&&n.send(e),n.json(t)})},n.createDangerzone=function(e,n){new r(e.body).save(function(e,t){e?n.json(e):n.json(t)})},n.getDangerzone=function(e,n){r.findById(e.params.dangerzoneId,function(e,t){e&&n.send(e),n.json(t)})},n.deleteDangerzone=function(e,n){r.remove({_id:e.params.dangerzoneId},function(e,t){e&&n.send(e),n.json({code:"200"})})},n.updateDangerzone=function(e,n){r.findOneAndUpdate(e.params.dangerzoneId,e.body,{new:!0},function(e,t){e&&n.send(e),n.json(t)})}}]);