!function(e){function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}var t={};n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=1)}([function(e,n){e.exports=require("mongoose")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=t(2),o=t(3),s=n.app=r(),a=t(0),i=(t(8),t(9)),u=t(10);a.Promise=global.Promise,a.connect("mongodb://localhost/atasdb"),s.use(u()),s.use(i.urlencoded({extended:!0})),s.use(i.json()),t(11)(s);new o(a)},function(e,n){e.exports=require("express")},function(e,n,t){"use strict";function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),s=t(4),a=t(5),i=function(e){return e&&e.__esModule?e:{default:e}}(a),u=t(6),c=t(7);e.exports=function(){function e(n){r(this,e),this.mongoose=n,this.mqttTrackerObserver=null,this.trackersInsideDangerzoneList=[],this.message_alarmOff='{"port":1,"payload_fields":{"alarm": false}}',this.message_alarmOn='{"port":1,"payload_fields":{"alarm": true}}',this.mqttOptions={port:s.appConstants.MQTT_BROKER_PORT,host:s.appConstants.MQTT_BROKER_URL,clientId:s.appConstants.NAME+Math.random().toString(16).substr(2,8),username:s.appConstants.MQTT_BROKER_USER,password:s.appConstants.MQTT_BROKER_PASSWORD,keepalive:60,reconnectPeriod:2e3,protocolId:"MQIsdp",protocolVersion:3,clean:!0,encoding:"utf8"},this.trackerIDPattern=s.appConstants.MQTT_TOPIC_TRACKER+"+id/#path",this.init()}return o(e,[{key:"init",value:function(){function e(e){console.log("ERROR"+e)}this.mqttTrackerObserver=u.connect(s.appConstants.MQTT_BROKER_URL,this.mqttOptions);var n=this;this.mqttTrackerObserver.on("connect",function(){console.log(s.appConstants.NAME+" - Mqtt connected"),n.mqttTrackerObserver.subscribe(s.appConstants.MQTT_TOPIC_TRACKER+"+/up/gps"),n.mqttTrackerObserver.subscribe(s.appConstants.MQTT_TOPIC_TRACKER+"+/up/buttonpressed")}),this.mqttTrackerObserver.on("message",function(t,r,o){var a=(0,i.default)(n.trackerIDPattern).exec,u=a(t).id,p=s.appConstants.MQTT_TOPIC_TRACKER+u+"/down";switch(t){case s.appConstants.MQTT_TOPIC_TRACKER+u+"/up/gps":var l=JSON.parse(r.toString()),d=n.trackersInsideDangerzoneList.indexOf(u);n.mongoose.model("Dangerzone").find().exec(function(t,r){var o=!1;if(t)return e(t);for(var s=0;s<r.length;s++)if(c(l,r[s])){-1==d&&(n.mqttTrackerObserver.publish(p,n.message_alarmOn),n.trackersInsideDangerzoneList.push(u)),o=!0;break}0==o&&d>-1&&(n.mqttTrackerObserver.publish(p,n.message_alarmOff),n.trackersInsideDangerzoneList.splice(d,1))})}})}}]),e}()},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.appConstants={NAME:"ATAS Service",MQTT_BROKER_URL:"wss://m21.cloudmqtt.com",MQTT_BROKER_PORT:"37505",MQTT_BROKER_USER:"rpyifhax",MQTT_BROKER_PASSWORD:"SNr0uCxBVOK4",MQTT_TOPIC_TRACKER:"atas/devices/"}},function(e,n){e.exports=require("mqtt-regex")},function(e,n){e.exports=require("mqtt")},function(e,n,t){"use strict";e.exports=function(e,n){for(var t=e.lng,r=e.lat,o=n.points,s=!1,a=0,i=o.length-1;a<o.length;i=a++){var u=o[a].lng,c=o[a].lat,p=o[i].lng,l=o[i].lat;c>r!=l>r&&t<(p-u)*(r-c)/(l-c)+u&&(s=!s)}return s}},function(e,n,t){"use strict";var r=t(0),o=r.Schema,s=new o({createDate:{type:Date,default:Date.now},points:[{lat:Number,lng:Number}]});e.exports=r.model("Dangerzone",s)},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cors")},function(e,n,t){"use strict";e.exports=function(e){var n=t(12);e.route("/dangerzones").get(n.listDangerzones).post(n.createDangerzone),e.route("/dangerzones/:dangerzoneId").get(n.getDangerzone).put(n.updateDangerzone).delete(n.deleteDangerzone),e.use(function(e,n){n.status(404).send({url:e.originalUrl+" not found"})})}},function(e,n,t){"use strict";var r=t(0),o=r.model("Dangerzone");n.listDangerzones=function(e,n){o.find({},function(e,t){e&&n.send(e),n.json(t)})},n.createDangerzone=function(e,n){new o(e.body).save(function(e,t){e?n.json(e):n.json(t)})},n.getDangerzone=function(e,n){o.findById(e.params.dangerzoneId,function(e,t){e&&n.send(e),n.json(t)})},n.deleteDangerzone=function(e,n){o.remove({_id:e.params.dangerzoneId},function(e,t){e&&n.send(e),n.json({code:"200"})})},n.updateDangerzone=function(e,n){o.findOneAndUpdate(e.params.dangerzoneId,e.body,{new:!0},function(e,t){e&&n.send(e),n.json(t)})}}]);